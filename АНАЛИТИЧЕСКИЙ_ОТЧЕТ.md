# Аналитический отчет по проекту "КБЖУ Калькулятор с LLM"

## 1. Описание проекта: Цели, задачи и реализованный функционал

### 1.1 Цели проекта

Проект представляет собой веб-приложение для автоматизированного ведения дневника питания с использованием технологии Large Language Model (LLM). Основная цель — создать удобный инструмент для отслеживания калорий, белков, жиров и углеводов (КБЖУ) с минимальными усилиями пользователя благодаря естественно-языковому интерфейсу.

### 1.2 Задачи проекта

1. **Автоматическое извлечение данных из естественного языка**: Реализация системы, способной понимать сообщения пользователя в свободной форме и извлекать структурированные данные о питании, весе и активности.

2. **Ведение персонального профиля**: Создание и управление профилем пользователя с параметрами (возраст, рост, вес, пол, уровень активности, цели).

3. **Автоматический расчет целевых КБЖУ**: Вычисление персональных целей по калориям и макронутриентам на основе физиологических параметров и целей пользователя.

4. **Дневник питания и активности**: Ведение записей о потребленных блюдах, весе тела и физической активности с привязкой к датам.

5. **Статистика и аналитика**: Предоставление пользователю статистики по потреблению КБЖУ, динамике веса и прогрессу к достижению целей.

6. **Удобный интерфейс**: Создание современного, отзывчивого пользовательского интерфейса с поддержкой чат-интерфейса для общения с ассистентом.

### 1.3 Реализованный функционал

#### 1.3.1 Ядро приложения

**Управление профилем пользователя:**
- Создание профиля с параметрами: рост, вес, возраст, пол, уровень активности (sedentary, light, moderate, active, very_active)
- Установка цели: похудение (lose), поддержание веса (maintain), набор веса (gain)
- Указание целевого веса
- Автоматическое обновление профиля при предоставлении новой информации
- Валидация данных профиля с использованием библиотеки Zod

**Расчет целевых КБЖУ:**
- Расчет базового метаболизма (BMR) по формуле Миффлина-Сан Жеора
- Расчет общего дневного расхода энергии (TDEE) с учетом уровня активности
- Автоматическая корректировка калорийности в зависимости от цели:
  - Похудение: TDEE × 0.85
  - Набор веса: TDEE × 1.15
  - Поддержание: TDEE
- Расчет макронутриентов: белки (30% калорий), жиры (25% калорий), углеводы (остаток)

**Ведение дневника питания:**
- Добавление блюд с указанием названия и опционально — КБЖУ
- Автоматическая оценка КБЖУ для блюд через LLM, если значения не указаны
- Группировка записей по датам
- Поддержка множественных блюд в одной записи
- Автоматическое суммирование КБЖУ по дням

**Отслеживание веса:**
- Запись текущего веса с привязкой к дате
- Отображение динамики веса на графике
- Расчет среднего веса и изменения веса за период

**Учет физической активности:**
- Типы активности: ходьба (walking), бег (running), тренировка в зале (gym), велосипед (cycling), другое (other)
- Указание длительности активности
- Автоматический расчет калорий по формуле MET (Metabolic Equivalent of Task) с учетом веса пользователя
- Ручное указание сожженных калорий (имеет приоритет)
- Учет активности при расчете чистых калорий (потреблено минус сожжено)

**Статистика и аналитика:**
- Просмотр статистики за выбранный период
- Средние показатели КБЖУ за день
- Общие показатели за период
- Динамика веса (средний вес, изменение веса)
- Визуализация данных через графики (вес, КБЖУ по дням)

**Экспорт данных:**
- Экспорт в JSON формате (профиль, записи, цели)
- Экспорт в CSV формате (записи дневника)
- Экспорт в PDF (полный отчет с профилем, статистикой и записями)

**История активности:**
- Логирование всех действий пользователя (создание/обновление профиля, добавление еды, запись веса, обновление целей)
- Отображение истории действий с временными метками
- Связь действий с сообщениями в чате

#### 1.3.2 Интеграция с LLM

**Использование OpenRouter API:**
- Интеграция с OpenRouter.ai для доступа к различным LLM моделям
- Поддержка настройки модели через переменную окружения `VITE_LLM_MODEL`
- Модель по умолчанию: `openai/gpt-5.1-chat`
- Температура генерации: 0.9 (для более естественных ответов)

**Системный промпт:**
- Детально проработанный системный промпт, определяющий поведение ассистента
- Требование строгого формата JSON-ответов
- Определение действий (actions): `create_profile`, `update_profile`, `add_entry`, `update_goal`, `show_stats`, `show_goal`, `general`
- Инструкции по извлечению данных из естественного языка
- Правила обработки неполных данных

**Обработка ответов LLM:**
- Парсинг JSON-ответов с извлечением структурированных данных
- Обработка ошибок парсинга с fallback на обычный текст
- Валидация извлеченных данных
- Обогащение данных: автоматическая оценка КБЖУ для блюд без указанных значений

**Контекст пользователя:**
- Передача в LLM информации о профиле пользователя, последних записях и целях
- Форматирование контекста в удобном для LLM виде
- Поддержка пользовательского контекста (имя, предпочтения, заметки)

**Механизм повторных попыток:**
- Автоматические повторные попытки при ошибках API (до 3 попыток)
- Задержка между попытками: 1 секунда
- Обработка сетевых ошибок и ошибок API

#### 1.3.3 Технологический стек

**Фронтенд:**
- **React 19.2.0**: Современная библиотека для построения пользовательских интерфейсов
- **TypeScript 5.9.3**: Типизированный JavaScript для повышения надежности кода
- **Vite 7.2.2**: Быстрый сборщик и dev-сервер с Hot Module Replacement (HMR)
- **Tailwind CSS 3.4.0**: Utility-first CSS фреймворк для быстрой разработки UI
- **Zustand 5.0.8**: Легковесная библиотека для управления состоянием
- **date-fns 4.1.0**: Утилиты для работы с датами
- **react-markdown 10.1.0**: Рендеринг Markdown в React компонентах
- **lucide-react 0.554.0**: Библиотека иконок
- **Zod 4.1.12**: Схемы валидации TypeScript-first

**Хранение данных:**
- **localStorage**: Клиентское хранилище для профиля, записей, истории чата и логов активности
- Структурированное хранение с отдельными ключами для каждого типа данных
- Автоматическое сохранение при каждом изменении

**API и интеграции:**
- **OpenRouter API**: Унифицированный API для доступа к различным LLM моделям
- Настройка через переменные окружения
- Авторизация через Bearer токен

**Инструменты разработки:**
- **ESLint 9.39.1**: Линтер для поддержания качества кода
- **TypeScript ESLint 8.46.3**: ESLint плагин для TypeScript
- **PostCSS 8.5.6**: Обработка CSS
- **Autoprefixer 10.4.22**: Автоматическое добавление vendor префиксов

### 1.4 Архитектура приложения

**Структура проекта:**

```
src/
├── components/        # React компоненты UI
│   ├── ui/           # Базовые UI компоненты (button, input, card и т.д.)
│   ├── ChatInterface.tsx
│   ├── EntriesList.tsx
│   ├── MessageBubble.tsx
│   ├── ProcessingIndicator.tsx
│   └── ...
├── hooks/            # Кастомные React хуки
│   ├── useChat.ts    # Хук для работы с чатом
│   ├── useCommands.ts
│   └── useKBJU.ts
├── lib/              # Бизнес-логика и утилиты
│   ├── types.ts      # TypeScript типы
│   ├── systemPrompt.ts  # Системный промпт для LLM
│   ├── openrouter.ts    # Интеграция с OpenRouter API
│   ├── calculations.ts  # Расчеты КБЖУ, BMR, TDEE
│   ├── storage.ts       # Работа с localStorage
│   ├── validation.ts    # Валидация данных (Zod схемы)
│   ├── mealEstimation.ts # Оценка КБЖУ блюд через LLM
│   ├── activityCalories.ts # Расчет калорий активности
│   ├── profileUpdate.ts   # Обновление профиля
│   └── export.ts         # Экспорт данных
├── services/         # Сервисы
│   ├── llmService.ts      # Сервис работы с LLM (повторные попытки)
│   └── messageProcessor.ts # Обработка сообщений и действий LLM
└── store/            # Zustand stores
    ├── dataStore.ts      # Состояние данных (профиль, записи, цели)
    ├── chatStore.ts      # Состояние чата (сообщения, загрузка)
    └── activityLogStore.ts # Логи активности
```

**Поток обработки сообщения:**

1. Пользователь отправляет сообщение в чат
2. Сообщение добавляется в историю чата
3. Вызывается `processMessage` из `messageProcessor`
4. Формируется контекст для LLM (профиль, записи, цели)
5. Создается системный промпт на основе текущего состояния
6. Отправляется запрос к OpenRouter API через `callLLM`
7. LLM возвращает JSON-ответ с действием и данными
8. JSON парсится и валидируется
9. В зависимости от действия выполняется соответствующая обработка:
   - `create_profile`: создание нового профиля и расчет целей
   - `update_profile`: обновление существующего профиля
   - `add_entry`: добавление записи о еде/весе/активности
   - `update_goal`: обновление целевых КБЖУ
   - `show_stats`: отображение статистики
   - `show_goal`: отображение целей
   - `general`: общий ответ без действий
10. Результат сохраняется в store и localStorage
11. Ответ ассистента отображается пользователю

### 1.5 Особенности реализации

**Умная обработка данных:**
- Система автоматически определяет, какие данные были извлечены из сообщения пользователя
- Обновляются только те поля, которые были упомянуты
- При изменении ключевых параметров профиля (вес, рост, возраст, пол, активность, цель) автоматически пересчитываются целевые КБЖУ

**Обогащение данных:**
- Если пользователь указал только название блюда без КБЖУ, система автоматически оценивает КБЖУ через LLM
- Расчет калорий активности использует формулу MET с учетом веса пользователя
- Поддержка ручного указания калорий с приоритетом над расчетом

**Валидация на всех уровнях:**
- Валидация данных профиля (рост: 100-250 см, вес: 30-300 кг, возраст: 10-120 лет)
- Валидация записей дневника (формат даты, структура блюд, веса)
- Валидация целей КБЖУ (неотрицательные значения)
- Использование Zod для типобезопасной валидации

**Обработка ошибок:**
- Error Boundary для перехвата ошибок React
- Обработка ошибок API с повторными попытками
- Информативные сообщения об ошибках для пользователя
- Toast-уведомления для обратной связи

**UX оптимизации:**
- Индикаторы обработки с описанием текущего этапа (извлечение, обработка, сохранение)
- Автоматическая прокрутка чата к последним сообщениям
- Анимации появления элементов
- Адаптивный дизайн

## 2. Тестирование: Описание процесса тестирования и найденных проблем

### 2.1 Процесс тестирования

**Ручное тестирование функционала:**

1. **Тестирование создания профиля:**
   - Проверка создания профиля через естественный язык ("Мне 25 лет, рост 175, вес 70 кг")
   - Валидация извлечения всех параметров
   - Проверка автоматического расчета целевых КБЖУ
   - Тестирование создания профиля с неполными данными

2. **Тестирование добавления записей:**
   - Добавление блюд с указанием КБЖУ ("Овсянка 150 ккал, 5г белка, 3г жира, 25г углеводов")
   - Добавление блюд без КБЖУ ("Я съел яблоко и бутерброд")
   - Проверка автоматической оценки КБЖУ через LLM
   - Тестирование записи веса ("Вес 75.5 кг")
   - Добавление активности ("Бег 30 минут")

3. **Тестирование обработки ошибок:**
   - Тестирование работы без API ключа
   - Тестирование обработки некорректных JSON-ответов от LLM
   - Проверка повторных попыток при сетевых ошибках
   - Тестирование валидации данных

4. **Тестирование сохранения данных:**
   - Проверка сохранения в localStorage при каждом действии
   - Проверка восстановления данных при перезагрузке страницы
   - Тестирование очистки данных

5. **Тестирование экспорта:**
   - Проверка экспорта в JSON
   - Проверка экспорта в CSV
   - Проверка экспорта в PDF

### 2.2 Найденные проблемы и их решения

**Проблема 1: Некорректный парсинг JSON от LLM**

**Описание:** Иногда LLM возвращала ответ в формате Markdown с кодом (```json ... ```) или с дополнительным текстом до/после JSON.

**Решение:** Реализован парсинг с извлечением JSON через регулярное выражение:
```typescript
const jsonMatch = text.match(/\{[\s\S]*\}/);
if (!jsonMatch) {
  return null;
}
const parsed = JSON.parse(jsonMatch[0]);
```

**Проблема 2: Отсутствие валидации данных от LLM**

**Описание:** LLM могла вернуть невалидные данные (отрицательный вес, несуществующий тип активности и т.д.).

**Решение:** Добавлена валидация всех данных через Zod схемы перед сохранением. При ошибке валидации пользователю показывается сообщение об ошибке.

**Проблема 3: Частые ошибки при запросах к API**

**Описание:** При временных сбоях API или сетевых проблемах запросы падали без повторных попыток.

**Решение:** Реализован механизм повторных попыток с экспоненциальной задержкой:
- До 3 попыток
- Задержка 1 секунда между попытками
- Обработка различных типов ошибок

**Проблема 4: Неполная оценка КБЖУ для блюд**

**Описание:** При отсутствии КБЖУ у блюда система не могла его оценить автоматически.

**Решение:** Создан отдельный сервис `mealEstimation.ts`, который через LLM оценивает КБЖУ для блюд на основе их названия. При добавлении блюд без КБЖУ автоматически вызывается этот сервис.

**Проблема 5: Расчет калорий активности без учета веса**

**Описание:** Изначально расчет калорий активности не учитывал вес пользователя.

**Решение:** Реализован расчет через формулу MET (Metabolic Equivalent of Task):
```typescript
calories = MET × weight × hours
```
Где MET зависит от типа активности и интенсивности.

**Проблема 6: Отсутствие истории действий**

**Описание:** Пользователь не мог видеть историю своих действий.

**Решение:** Создан `activityLogStore` для логирования всех действий с временными метками и описаниями. Добавлен компонент `ActivityLogView` для отображения истории.

**Проблема 7: Потеря данных при закрытии браузера**

**Описание:** Данные не сохранялись между сессиями.

**Решение:** Все данные сохраняются в localStorage при каждом изменении. При загрузке приложения данные автоматически восстанавливаются из localStorage.

### 2.3 Ограничения текущего тестирования

1. **Отсутствие автоматических тестов:** В проекте нет unit-тестов, integration-тестов или e2e-тестов. Все тестирование выполняется вручную.

2. **Нет тестирования на различных моделях LLM:** Тестирование проводилось только с одной моделью (`openai/gpt-5.1-chat`). Разные модели могут вести себя по-разному.

3. **Ограниченное тестирование граничных случаев:** Не все граничные случаи покрыты тестами (например, очень большие значения, специальные символы в названиях блюд).

4. **Нет нагрузочного тестирования:** Не проверялась работа системы при большом количестве записей или частых запросах к API.

### 2.4 Рекомендации по улучшению тестирования

1. **Добавить unit-тесты:**
   - Тесты для функций расчета (BMR, TDEE, КБЖУ)
   - Тесты для валидации данных
   - Тесты для работы с хранилищем

2. **Добавить integration-тесты:**
   - Тесты для обработки сообщений
   - Тесты для интеграции с LLM API
   - Тесты для обогащения данных

3. **Добавить e2e-тесты:**
   - Тесты критических пользовательских сценариев
   - Тесты создания профиля, добавления записей, просмотра статистики

4. **Добавить тесты для различных моделей LLM:**
   - Тестирование с разными моделями через OpenRouter
   - Сравнение качества извлечения данных

## 3. Выводы и перспективы: Оценка результатов и возможности для дальнейшего развития

### 3.1 Оценка результатов

**Достигнутые цели:**

1. ✅ **Успешная интеграция LLM для извлечения данных:** Система успешно извлекает структурированные данные из естественного языка с высокой точностью благодаря детально проработанному системному промпту.

2. ✅ **Автоматизация рутинных задач:** Пользователь может вести дневник питания, просто описывая то, что он съел, без необходимости заполнять формы.

3. ✅ **Точные расчеты КБЖУ:** Реализованы проверенные формулы для расчета BMR, TDEE и целевых КБЖУ с учетом индивидуальных параметров пользователя.

4. ✅ **Удобный пользовательский интерфейс:** Современный, отзывчивый интерфейс с чат-взаимодействием, которое интуитивно понятно пользователям.

5. ✅ **Надежное хранение данных:** Все данные сохраняются локально и восстанавливаются при перезагрузке.

6. ✅ **Расширяемая архитектура:** Модульная структура кода позволяет легко добавлять новый функционал.

**Ключевые преимущества решения:**

- **Естественный язык:** Пользователь может общаться с приложением так, как он общается с человеком
- **Автоматизация:** Минимум ручного ввода данных
- **Персонализация:** Учет индивидуальных параметров пользователя при расчетах
- **Всесторонний учет:** Отслеживание питания, веса и активности в одном месте
- **Визуализация:** Графики и статистика помогают отслеживать прогресс

**Ограничения текущей реализации:**

- **Зависимость от API:** Требуется стабильное подключение к интернету и наличие API ключа
- **Стоимость запросов:** Каждый запрос к LLM API стоит денег, что может быть затратно при частом использовании
- **Качество зависит от модели:** Разные LLM модели могут показывать разное качество извлечения данных
- **Ограничения localStorage:** Максимальный размер localStorage (обычно 5-10 МБ) может стать проблемой при большом количестве записей
- **Нет синхронизации:** Данные хранятся только локально, нет возможности синхронизации между устройствами

### 3.2 Возможности для дальнейшего развития

#### 3.2.1 Краткосрочные улучшения

**1. Расширение функционала оценки блюд:**
- Интеграция с базами данных продуктов (например, USDA FoodData Central, Open Food Facts)
- Кэширование оценок КБЖУ для часто используемых блюд
- Обучение модели на пользовательских данных для более точной оценки

**2. Улучшение обработки ошибок:**
- Более детальная обработка ошибок API с конкретными рекомендациями
- Offline-режим с возможностью отложенной синхронизации
- Fallback на более простую модель при ошибках основной модели

**3. Оптимизация производительности:**
- Кэширование результатов LLM для похожих запросов
- Batch-обработка нескольких блюд в одном запросе
- Ленивая загрузка компонентов и данных

**4. Улучшение UX:**
- Подсказки и автодополнение при вводе
- Быстрые действия (кнопки для часто используемых команд)
- Темная тема интерфейса
- Мобильная оптимизация

**5. Расширение статистики:**
- Прогнозирование достижения цели на основе текущего прогресса
- Рекомендации по корректировке питания
- Сравнение с предыдущими периодами
- Экспорт графиков и отчетов

#### 3.2.2 Среднесрочные улучшения

**1. Бэкенд и синхронизация:**
- Создание backend API для хранения данных
- Синхронизация данных между устройствами
- Облачное хранение с резервным копированием
- Многопользовательский режим

**2. Расширенная аналитика:**
- Анализ паттернов питания
- Выявление проблемных дней/периодов
- Корреляционный анализ между питанием, активностью и весом
- Рекомендательная система на основе ML

**3. Интеграции:**
- Интеграция с фитнес-трекерами (Fitbit, Apple Health, Google Fit)
- Интеграция с приложениями доставки еды для автоматического добавления блюд
- Интеграция с календарем для напоминаний
- Интеграция с социальными сетями для мотивации

**4. Социальные функции:**
- Публичные рецепты и блюда от других пользователей
- Групповые челленджи и соревнования
- Обмен прогрессом с друзьями
- Сообщество с советами и поддержкой

**5. Персонализация:**
- Адаптация системного промпта на основе стиля общения пользователя
- Обучение на истории пользователя для более точных оценок
- Индивидуальные рекомендации по питанию
- Учет пищевых ограничений и аллергий

#### 3.2.3 Долгосрочные перспективы

**1. AI/ML улучшения:**
- Fine-tuning собственной модели на данных пользователей
- Использование специализированных моделей для различных задач (извлечение данных, оценка КБЖУ, рекомендации)
- Компьютерное зрение для распознавания блюд по фотографии
- Голосовой ввод для еще большего удобства

**2. Медицинская интеграция:**
- Интеграция с медицинскими картами
- Учет медицинских показателей (сахар в крови, давление, холестерин)
- Интеграция с диетологами и врачами
- Соответствие медицинским стандартам и сертификациям

**3. Монетизация:**
- Freemium модель с базовым функционалом бесплатно
- Премиум подписка с расширенной аналитикой и функциями
- Партнерства с сервисами доставки еды и фитнес-центрами
- API для разработчиков

**4. Масштабирование:**
- Поддержка множества языков
- Локализация для разных стран
- Поддержка различных систем измерения (имперская, метрическая)
- Адаптация под различные диеты и культурные особенности

**5. Исследования и данные:**
- Анонимизированные данные для исследований питания
- Партнерства с университетами и исследовательскими центрами
- Публикация статистики и инсайтов
- Вклад в науку о питании

### 3.3 Технические улучшения

**1. Тестирование:**
- Добавление unit-тестов с покрытием >80%
- Integration-тесты для критических сценариев
- E2E-тесты с использованием Playwright или Cypress
- Нагрузочное тестирование

**2. DevOps:**
- CI/CD pipeline для автоматического деплоя
- Автоматическое тестирование при каждом PR
- Мониторинг и логирование ошибок (Sentry, LogRocket)
- Performance мониторинг

**3. Безопасность:**
- Шифрование данных в localStorage
- Защита API ключей на backend
- Аутентификация и авторизация пользователей
- GDPR compliance

**4. Производительность:**
- Code splitting и lazy loading
- Оптимизация bundle размера
- Service Workers для offline-работы
- CDN для статических ресурсов

### 3.4 Выводы

Проект "КБЖУ Калькулятор с LLM" успешно демонстрирует практическое применение технологии Large Language Models для решения реальной задачи — автоматизации ведения дневника питания. Ключевые достижения:

1. **Эффективная интеграция LLM:** Использование OpenRouter API позволяет легко переключаться между различными моделями и находить оптимальный баланс между качеством и стоимостью.

2. **Правильная архитектура:** Модульная структура, разделение ответственности, использование TypeScript и валидации данных обеспечивают надежность и поддерживаемость кода.

3. **Хороший UX:** Естественно-языковый интерфейс делает приложение доступным и удобным для широкого круга пользователей.

4. **Расширяемость:** Архитектура позволяет легко добавлять новый функционал без значительной переработки существующего кода.

**Области для улучшения:**

- Добавление автоматических тестов для повышения надежности
- Создание backend для синхронизации и расширенных функций
- Оптимизация затрат на API через кэширование и более эффективные запросы
- Улучшение обработки ошибок и edge cases

Проект имеет большой потенциал для дальнейшего развития и может стать полноценным продуктом для массового использования с дополнительными функциями, которые сделают его конкурентоспособным на рынке приложений для здоровья и питания.

---

**Дата составления отчета:** 18 ноября 2025  
**Версия проекта:** 0.0.0  
**Основные технологии:** React 19, TypeScript, Vite, Zustand, Tailwind CSS, OpenRouter API


