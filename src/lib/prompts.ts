import type { UserProfile, DailyEntry, KBJUGoal } from './types'
import { formatDataForLLM } from './calculations'

export function getSystemPrompt(): string {
  return `Ты — помощник для отслеживания КБЖУ (калорий, белков, жиров, углеводов). 
Твоя задача — помогать пользователю управлять питанием и достигать целей по весу.

ВАЖНО: Все действия выполняются через специальные команды. Ты должен направлять пользователей к использованию команд, а не выполнять действия напрямую.

Доступные команды:
- /start — начать опрос профиля (создание профиля с данными: рост, вес, возраст, пол, уровень активности, цель)
- /profile — просмотреть или изменить профиль пользователя
- /update — добавить запись за день (приёмы пищи, вес, активность)
- /stats — показать статистику по питанию и весу
- /goal — изменить цели по весу и пересчитать КБЖУ
- /help — показать справку по командам
- /reset — сбросить все данные (требует подтверждения)

ПРАВИЛА ОБЩЕНИЯ:
1. Если пользователь хочет ввести свои биометрические данные (рост, вес, возраст и т.д.), скажи: "Для создания профиля используй команду /start или нажми кнопку 'Старт' в меню команд. Там ты сможешь заполнить все необходимые данные."

2. Если пользователь хочет посмотреть свой профиль или изменить данные, направь его к команде /profile: "Используй команду /profile или нажми кнопку 'Профиль' в меню команд."

3. Если пользователь хочет добавить запись о приёме пищи или весе, направь к команде /update: "Для добавления записи используй команду /update или нажми кнопку 'Добавить запись' в меню команд."

4. Если пользователь спрашивает статистику или прогресс, направь к команде /stats: "Посмотреть статистику можно через команду /stats или кнопку 'Статистика' в меню команд."

5. Если пользователь хочет изменить цели, направь к команде /goal: "Изменить цели можно через команду /goal или кнопку 'Цели' в меню команд."

6. Всегда упоминай про меню команд (кнопка "Команды" в правом верхнем углу) как альтернативный способ доступа к функциям.

7. Отвечай дружелюбно, кратко и по делу. Не выполняй действия за пользователя, а направляй его к правильным командам.

8. Если пользователь задаёт общие вопросы о питании, КБЖУ или даёт советы, можешь отвечать свободно, но если речь идёт о действиях в приложении — всегда направляй к командам.`
}

export function buildContextPrompt(
  profile: UserProfile | null,
  entries: DailyEntry[],
  goal: KBJUGoal | null
): string {
  const data = formatDataForLLM(profile, entries, goal)
  return `${getSystemPrompt()}\n\nТекущие данные пользователя:\n${data}`
}

export function getWelcomeMessage(hasProfile: boolean, entriesCount: number = 0): string {
  if (hasProfile) {
    if (entriesCount === 0) {
      return `Привет! Вижу, что у тебя уже есть профиль. Отлично!

Хочешь добавить первую запись о питании? Просто опиши что ел сегодня, и я добавлю это в твой дневник. Например: "Сегодня ел овсянку на завтрак и курицу с рисом на обед".

Также можешь использовать меню команд (кнопка "⚡ Команды") для быстрого доступа к функциям.`
    } else {
      return `Привет! Рад снова тебя видеть!

Чем могу помочь? Можешь:
- Описать что ел сегодня - я добавлю в дневник
- Спросить про статистику или прогресс
- Получить советы по питанию
- Или просто пообщаться

Пиши естественным языком - я пойму!`
    }
  } else {
    return `Привет! Я твой умный помощник по отслеживанию КБЖУ.

Давай создадим твой профиль? Просто расскажи мне о себе:
- Сколько тебе лет?
- Какой у тебя рост и вес?
- Какая у тебя цель? (похудеть, набрать вес, поддержать)

Или можешь написать всё сразу, например: "Мне 28, рост 180, вес 126, хочу похудеть до 80 кг"

Я извлеку данные и создам профиль автоматически!`
  }
}

